---
title: "Microbiome analysis genus"
output: html_document
---

#Load libraries
```{r}
library(phyloseq)
library(microbiome)
library(ggplot2)
library(ggpubr)
library(rstatix)
library(RColorBrewer)
library(gghighlight)
library(UpSetR)
library(ComplexHeatmap)
```

#Load and format data
```{r}
#Read TABLE, TAXONOMY and METADATA
#row taxon/col samples
tabla_GEN=data.frame(t(read.csv('./Data/p_nt_enrich_fMAG_GEN_count_bracken.txt',sep='\t',row.names = 1,check.names = F)),check.names = F)
taxa_GEN=read.csv('./Data/taxa_nt_enrich_fMAG_GEN.txt',sep='\t')
metadata=read.csv('./Data/metadata_all_def.csv',header = T, sep='\t',row.names = 1)

#Change row names to desired format for TABLE and TAXONOMY
#(We can do this with out problem, because the TAXONOMY table was created based on the order of the TABLE table) 
row.names(tabla_GEN)=taxa_GEN$genus
row.names(taxa_GEN)=taxa_GEN$genus
```

#Filter undesired taxa for TABLE and TAXONOMY
```{r}
#Define %not_in% function
`%not_in%` <- purrr::negate(`%in%`)
#Filter kingdoms Metazoa(33208) and Viridiplantae(33090)and undefined taxa(NAs)
tax_GEN_filtered=taxa_GEN[taxa_GEN$kingdom %not_in% c('Viridiplantae(33090)','Metazoa(33208)'),]
tax_GEN_filtered=tax_GEN_filtered[!is.na(tax_GEN_filtered$superkingdom),]
tabla_GEN_filtered=tabla_GEN[row.names(tabla_GEN) %in% tax_GEN_filtered$genus,]
```

#Make phyloseq object
```{r}
#Pre-format 
##Taxa
tax_mat_GEN=as.matrix(tax_GEN_filtered)
TAX_GEN=tax_table(tax_mat_GEN)
##Count_data as matrix
matr_tabla_GEN=as.matrix(tabla_GEN_filtered)
t_GEN=otu_table(matr_tabla_GEN,taxa_are_rows = T)
##Metadata
samples_meta=sample_data(metadata)
#Transform to phyloseq object 
pseq=phyloseq(t_GEN,samples_meta,TAX_GEN)
#keep only taxa with positive sums
pseq<-prune_taxa(taxa_sums(pseq)>0,pseq)
pseq
```

#Normalization - proporcions
```{r}
#Get "compositional" version of data(Relative abundance/ Proporcions)
pseq.rel <- microbiome::transform(pseq, "compositional")
```

#Microbial composition description / Top 25 taxa GEN -> Supplementary Figure4

##Self-made function (taxa_avg_abund)
```{r}
taxa_avg_abund <- function(x) {
    
    sort(rowSums(microbiome::abundances(x)), decreasing=TRUE)/nsamples(x)
    
}
```

###Get Data-Table
```{r}
#Get top 25 most abundand taxa 
top25_tax=top_taxa(pseq.rel,n=25)
pseq.rel.top25_tax=prune_taxa(top25_tax,pseq.rel)
#Reshape data
top25_tax_abund=reshape2::melt(otu_table(pseq.rel.top25_tax))
top25_tax_abund=setNames(top25_tax_abund,c("Tax","Sample","Abundance"))
#Add metadata
top25_tax_data=merge(top25_tax_abund,metadata,by.x="Sample",by.y="row.names")
#Create new variable summing lifestyle+country
top25_tax_data$CT_LF <- paste(top25_tax_data$country,':',top25_tax_data$host_lifestyle)
```

###Summary stats for top taxa
```{r}
##Compute avg abundances for top taxa
taxa_avg_abund(pseq.rel.top25_tax)
```

###Boxplot compositions
```{r}
#Create boxplot
dot_plot=ggplot(data=top25_tax_data, aes(y=reorder(Tax, Abundance, FUN = mean), x= Abundance))+geom_boxplot(aes(fill=Tax))
#Format graph
dot_plot=dot_plot+xlab("Relative abundance")+ylab("Top 25 Taxa")
#Add means to graph
dot_plot=dot_plot+stat_summary(aes(group=Tax),fun=mean, geom="point", shape=25, size=2, color="black", fill="red")
#Change theme and remove legend
dot_plot=dot_plot+theme_bw()+theme(legend.position = "none")
#Show result
print(dot_plot)
ggsave("./Supplementary/Supplementary_Figure4.pdf",plot=dot_plot,height = 12, width = 18,dpi=600)
```

#Core analysis

##Universal Core (Intersection between cores) / Figure 2A
```{r}
#Set thresholds
PREV=0.9
ABUND=0.0001

#Pan-Core (>0.0001 relative abundance in => 90% of all samples)
pseq.core <- core(pseq.rel, detection = ABUND, prevalence = PREV,include.lowest = T)
core.taxa.all <- core_members(pseq.rel, detection = ABUND, prevalence = PREV,include.lowest = T)

#Cores by life style
pseq.rel_Rural= prune_samples(meta(pseq.rel)$host_lifestyle == "Rural",pseq.rel)
core.taxa.rural <- core_members(pseq.rel_Rural, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Urban= prune_samples(meta(pseq.rel)$host_lifestyle == "Urban",pseq.rel)
core.taxa.Urban <- core_members(pseq.rel_Urban, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_PS= prune_samples(meta(pseq.rel)$host_lifestyle == "Periurban shantytown",pseq.rel)
core.taxa.PS <- core_members(pseq.rel_PS, detection = ABUND, prevalence = PREV,include.lowest = T)

#Cores by country
pseq.rel_China= prune_samples(meta(pseq.rel)$country == "China",pseq.rel)
core.taxa.China <- core_members(pseq.rel_China, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Peru= prune_samples(meta(pseq.rel)$country == "Peru",pseq.rel)
core.taxa.Peru <- core_members(pseq.rel_Peru, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Md= prune_samples(meta(pseq.rel)$country == "Madagascar",pseq.rel)
core.taxa.Md <- core_members(pseq.rel_Md, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Japan= prune_samples(meta(pseq.rel)$country == "Japan",pseq.rel)
core.taxa.Japan <- core_members(pseq.rel_Japan, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Sal= prune_samples(meta(pseq.rel)$country == "El Salvador",pseq.rel)
core.taxa.Sal <- core_members(pseq.rel_Sal, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_US= prune_samples(meta(pseq.rel)$country == "United States",pseq.rel)
core.taxa.US <- core_members(pseq.rel_US, detection = ABUND, prevalence = PREV,include.lowest = T)

#Get presence-absence data.frame
listIn= list(core.taxa.all,core.taxa.rural,core.taxa.Urban,core.taxa.PS,core.taxa.China,core.taxa.Peru,core.taxa.Md,core.taxa.Japan,core.taxa.Sal,core.taxa.US)
cores_df<-as.data.frame(list_to_matrix(listIn))
#Change names
colnames(cores_df)<- c("Pan-Core","Rural","Urban","Periurban shantytown","China","Peru","Madagascar","Japan","El Salvador","United States")
#Create metadatos data.frame  for coloring
variables<-c("Pan","Style","Style","Style","Country","Country","Country","Country","Country","Country")
sets<-c("Pan-Core","Rural","Periurban shantytown","Urban","Peru","Madagascar","El Salvador","Japan","China","United States")
metadatos<- as.data.frame(cbind(sets,variables))

#Plot and show 
interset_cores <- upset(cores_df, mainbar.y.label="Number of Intersecting Taxa",sets.x.label="Number of Core Taxa",sets = c("Pan-Core","Urban","Periurban shantytown","Rural","Japan","China","United States","Peru","Madagascar","El Salvador"),order.by = "freq",keep.order = TRUE, text.scale = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5),set.metadata = list(data = metadatos, plots = list(list(type = "matrix_rows", column = "variables", colors = c(Pan = "green", Style = "yellow", Country = "purple")))))

#Save plot png
#png(file="./intermediate/core_intersections_GEN_rel_0.0001_preval_0.9.png",width=10, height=6)
#interset_cores
#dev.off()

#Save plot pdf
pdf(file="./intermediate/core_intersections_GEN_rel_0.0001_preval_0.9.pdf",width=10, height=6)
interset_cores
dev.off()
```

##Get Universal core taxa(Intersect)
```{r}
universal_core_taxa=row.names(cores_df %>% dplyr::filter_all(dplyr::all_vars(.==1)))
pseq.uni_core= prune_taxa(universal_core_taxa,pseq.rel)
```

##Get Prevalence-Abundance Heatmap/ Figure 2C
```{r}
#Original plot
##Set parameters
prevalences <- seq(.05, 1, .05)
detections <- c(0.01, 0.1, 0.5, 1,5,10)/100
color=rev(RColorBrewer::brewer.pal(9, "Spectral"))

##Initial Plot to get data
p_core1 <- plot_core(pseq.uni_core, plot.type = "heatmap", colours = color,
    prevalences = prevalences, detections = detections)

##Get input format
input_data=reshape2::acast(p_core1$data,Taxa~DetectionThreshold,value.var = "Prevalence")

##Order by abundance
input_data=input_data[names(taxa_avg_abund(pseq.uni_core)),]

##Get Avg relative abund values
avg_rel=as.vector(taxa_avg_abund(pseq.uni_core))

##Get phylums for ASVs
phy_tax=c()
for (i in names(taxa_avg_abund(pseq.uni_core))) {
  temp_row=tax_table(pseq.uni_core)[i,"phylum"]
  phy_tax=c(phy_tax,temp_row)
  }

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
avg_rel_col=circlize::colorRamp2(c(0,0.005,0.01,0.05,0.1,0.2), c("grey",rev(RColorBrewer::brewer.pal(n = 5, name = "RdYlBu"))))


##Include annotations
lateral_info <-ComplexHeatmap::rowAnnotation(Phylum=phy_tax,`Average Relative \nAbundance`=avg_rel,
                                             show_annotation_name = c(FALSE,FALSE),gp = grid::gpar(col ="black"),
                                             col=list(Phylum=phy_col,`Average Relative \nAbundance`=avg_rel_col),
                                             annotation_legend_param=list(`Average Relative \nAbundance`=list(legend_height = unit(4, "cm"), at=c(0,0.005,0.01,0.05,0.1,0.2))))

##Get initial heatmap
ht<-ComplexHeatmap::Heatmap(input_data,heatmap_legend_param=list(title="Prevalence",at=c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)),show_column_names = TRUE,
                        row_order = rownames(input_data), column_order = colnames(input_data),column_names_rot = 45,column_title_side = "bottom",
                        column_title = "Detection Threshold (Relative Abundance)",row_names_max_width = unit(10, "cm"),border_gp = grid::gpar(col = "black", lty = 1),
                        col = rev(RColorBrewer::brewer.pal(n = 10, name = "Spectral")),rect_gp = grid::gpar(col = "black", lwd = 2),
                        right_annotation = lateral_info,
                        cell_fun=function(j, i, x, y, w, h, col) { grid.text(round(input_data[i, j],3), x, y)})

##ajust legend
ComplexHeatmap::draw(ht, merge_legend = TRUE,heatmap_legend_side = "right", annotation_legend_side = "right")
```

```{r,eval=FALSE,include=TRUE}
#Save plot
png(filename = "./intermediate/heatmap_prev_abund_universal_core_gen.png", width = 10, height = 6, units = "in", res = 600)
ComplexHeatmap::draw(ht, merge_legend = TRUE,heatmap_legend_side = "right", annotation_legend_side = "right")
dev.off()
```

##Get taxa graph / Figure 2B
```{r,eval=FALSE,include=TRUE}
#Get copy to play with
pseq.uni_core_c <- pseq.uni_core
#Remove NA and re-order
tax_table(pseq.uni_core_c)<-tax_table(pseq.uni_core_c)[,c('superkingdom','phylum','class','order','family','genus')]
#Remove taxid from taxa-data
tax_table(pseq.uni_core_c)<-apply(tax_table(pseq.uni_core_c), 2, function(x) gsub("\\s*\\([^\\)]+\\)","",x))
#Load library and parse phyloseq
library(metacoder)
pseq.core_coder=parse_phyloseq(pseq.uni_core_c)
#Get graph
set.seed(42)
pseq_coder_graph_core<-heat_tree(pseq.core_coder,
                                 node_label = paste0(taxon_names, "[", n_obs, "]"),
                                 node_label_size=n_obs,
                                 node_color = ifelse(is_leaf, "#AADB31", "grey"),
                                 #layout="da",
                                 initial_layout="re",
                                 node_size=n_obs,
                                 repel_force = 5,
                                 edge_color = "skyblue",
                                 make_node_legend=F,
                                 node_label_size_trans = "area")
#Show graph
print(pseq_coder_graph_core)

#Save image
ggsave("./intermediate/core_genus.png",plot=pseq_coder_graph_core,height = 12, width = 18,dpi=600)
```

##Combine and Plot Figure 2
```{r}
#Load library
library(cowplot)
#Load images as ggplots
top <- ggdraw()+draw_image("./intermediate/core_intersections_GEN_rel_0.0001_preval_0.9.png")
bot <- ggdraw()+draw_image("./intermediate/heatmap_prev_abund_universal_core_gen.png")
#Combine plots
ri_fig<-plot_grid(top,bot,nrow = 2)
ri_fig2<-plot_grid(NULL,NULL,labels = c('A','C'),nrow = 2)
fig<-plot_grid(ri_fig2,ri_fig,pseq_coder_graph_core,NULL, labels = c("","","B",""),rel_widths = c(0.07,1,1,0.05),ncol = 4)
#Save plot
ggsave(plot=fig,filename = "./Figures/Figure2.pdf",units = "mm",height = 120, width = 190,scale = 1,dpi=600)
```

##Get all cores taxa table/ Supplementary Table 5
```{r}
#Get Taxonomies
All_Cores_list=rownames(cores_df)
pseq.GEN_All_Cores=prune_taxa(All_Cores_list,pseq.rel)
taxo_GEN_All_Cores=data.frame(tax_table(pseq.GEN_All_Cores))

#Combine with presence-absense object
All_Cores_taxa=merge(taxo_GEN_All_Cores,cores_df,by=0)
#Remove row.names column and kingdom(empty column)
All_Cores_taxa$Row.names<-NULL
All_Cores_taxa$kingdom<-NULL
#Add Universal core column(intersect)
Universal=c()
for (i in All_Cores_taxa$genus) {
  if (i %in% universal_core_taxa) {
    Universal=c(Universal,1)
  } else{Universal=c(Universal,0)}
}
All_Cores_taxa$Universal=Universal
#Re-order rows so Universal taxa go first
All_Cores_taxa <- All_Cores_taxa[order(-All_Cores_taxa$Universal),]
#Save the resulting table to excel file
library("writexl")
writexl::write_xlsx(All_Cores_taxa,"./Supplementary/Supplementary_Table5.xlsx")
```

#Principal Component Analysis/ Figure 5
```{r}
#PCA (RDA with out constrictions is equivalent to PCA) 
ord_pca <- phyloseq::ordinate(pseq.rel, method="RDA")

#We see the variation of variance explained by the components(first 5 comxponents)
pc5=sapply(ord_pca$CA$eig[1:5], function(x) x / sum(ord_pca$CA$eig))

#Plot Samples PCA by Lifestyle
pca_plot=plot_ordination(pseq.rel, ord_pca, color="host_lifestyle")
pca_plot=pca_plot + geom_point(size=5, alpha=0.75)
pca_plot=pca_plot + scale_colour_manual(name = "Lifestyle", labels = c("Periurban", "Rural", "Urban"),values=brewer.pal(n=3,name = "Set1"))
pca_plot=pca_plot + stat_ellipse(aes(group = host_lifestyle), linetype = 2)
pca_plot=pca_plot + theme_bw()+theme(axis.title.y = element_text(size=20),axis.title.x = element_text(size=20),legend.title=element_text(size=15),legend.text=element_text(size=15))
print(pca_plot)

#Plot Samples PCA by Country
pca_plot2=plot_ordination(pseq.rel, ord_pca, color="country")
pca_plot2=pca_plot2 + geom_point(size=5, alpha=0.75)
pca_plot2=pca_plot2 + scale_colour_brewer(type="qual", palette="Accent")
pca_plot2=pca_plot2 + stat_ellipse(aes(group = country), linetype = 2)
pca_plot2=pca_plot2 + labs(color='Country')
pca_plot2=pca_plot2 + theme_bw()+theme(axis.title.y = element_text(size=20),axis.title.x = element_text(size=20),legend.title=element_text(size=15),legend.text=element_text(size=15))
print(pca_plot2)
```

```{r}
#Get PCA components with scores for taxa
pca_scores=vegan::scores(ord_pca, choices=c(1,2),display=c("species"))

PC1_LAB=paste("PC1 [",round(pc5["PC1"]*100,digits = 1),"%]",sep ='')
PC2_LAB=paste("PC2 [",round(pc5["PC2"]*100,digits = 1),"%]",sep ='')

#TOP 20 in PC1
top20=names(rev(sort(abs(pca_scores[,"PC1"]))))[1:20]
pc1_tax=pca_scores[top20,"PC1"]
Taxa=names(pc1_tax)
Values=pc1_tax
Values_positive=Values>0
pc1_taxa_df=data.frame(Taxa,Values,Values_positive)

pc1_plot=ggplot(data = pc1_taxa_df, aes(x=reorder(Taxa,Values),y=Values,fill=Values_positive))+geom_bar(stat = "identity")
pc1_plot=pc1_plot + coord_flip() + scale_fill_manual("legend",values=c("FALSE"="#377EB8","TRUE"="#4DAF4A"))
pc1_plot=pc1_plot + theme(axis.text.y = element_text(color="black"),legend.position = "none")
pc1_plot=pc1_plot + labs(x="",y=PC1_LAB)+theme(panel.border = element_rect(fill = NA))
pc1_plot=pc1_plot + theme(axis.title.y = element_text(size=20),axis.title.x = element_text(size=20))
pc1_plot=pc1_plot + scale_x_discrete(position = "top")
print(pc1_plot)

#TOP 20 in PC2
top20=names(rev(sort(abs(pca_scores[,"PC2"]))))[1:20]
pc2_tax=pca_scores[top20,"PC2"]
Taxa=names(pc2_tax)
Values=pc2_tax
Values_positive=Values>0
pc2_taxa_df=data.frame(Taxa,Values,Values_positive)

pc2_plot=ggplot(data = pc2_taxa_df, aes(x=reorder(Taxa,Values),y=Values,fill=Values_positive))+geom_bar(stat = "identity")
pc2_plot=pc2_plot + coord_flip() + scale_fill_manual("legend",values=c("TRUE"="#E41A1C","FALSE"="#FF7F00"))
pc2_plot=pc2_plot + theme(axis.text.y = element_text(color="black"),legend.position = "none")
pc2_plot=pc2_plot + labs(x="",y=PC2_LAB)+theme(panel.border = element_rect(fill = NA))
pc2_plot=pc2_plot + theme(axis.title.y = element_text(size=20),axis.title.x = element_text(size=20))
pc2_plot=pc2_plot + scale_x_discrete(position = "top")
print(pc2_plot)
```

```{r}
library(cowplot)
#Adjust legend
pca_plot=pca_plot+theme(legend.justification = c(0,0.5))
pca_plot2=pca_plot2+theme(legend.justification = c(0,0.5))

#Combine plots
left_fig<-plot_grid(pca_plot,pca_plot2,labels = c('A','B'),nrow = 2,align = "v",rel_heights = c(1,1))
ri_fig<-plot_grid(pc1_plot,pc2_plot,nrow=2,align = "v")
fig<-plot_grid(left_fig,NULL,ri_fig,rel_widths = c(1.4,0.05,1),labels=c('','C'),nrow = 1,align = "hv")
fig

#Save plot
ggsave(plot=fig,filename = "./Figures/Figure5.pdf",units = "mm",height = 120, width = 190,scale = 2,dpi=600)
```

##Abundance Heatmap core individuals GEN / Supplementary Fig 7 A
```{r}
#Heatmap abudance
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get table
m=as.data.frame(otu_table(pseq.uni_core_m))

##Get Country:Lifestyle labels
fa_split=paste(as.data.frame(sample_data(pseq.uni_core_m))$country,':',as.data.frame(sample_data(pseq.uni_core_m))$host_lifestyle)

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col3=circlize::colorRamp2(c(0,0.001,0.005,0.01,0.05,0.1,0.2,0.4,0.8,1), c(rev(RColorBrewer::brewer.pal(n = 10, name = "RdYlBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=sample_data(pseq.uni_core_m)$host_lifestyle,
                              Country=sample_data(pseq.uni_core_m)$country,show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=as.vector(tax_table(pseq.uni_core_m)[,"phylum"]),
                          show_annotation_name = F, col=list(Phylum=phy_col),
                          gp = gpar(col = "black"),show_legend=F)
#Get heatmap
ht<-Heatmap(m,clustering_distance_rows = "euclidean",clustering_method_rows = "complete",
            clustering_distance_columns = "euclidean",clustering_method_columns = "complete",
            column_split = fa_split,show_column_names = F, column_title = " ", col = col3,
            border_gp = grid::gpar(col = "black", lty = 1),
            show_heatmap_legend = F,top_annotation = top_info, right_annotation = left_info)
#Convert to ggplot
gb_S7A=grid.grabExpr(draw(ht))
gg_S7A=as_ggplot(gb_S7A)
gg_S7A
```

##Common legend for Supplementary Fig 7
```{r}
#Create and combine legends
lgd1=Legend(labels = names(phy_col),legend_gp = gpar(fill=phy_col),title = "Phylum")
lgd2=Legend(labels = names(lifestyle_col),legend_gp = gpar(fill=lifestyle_col),title = "Lifestyle")
lgd3=Legend(labels = names(country_col),legend_gp = gpar(fill=country_col),title = "Country")
lgd4=Legend(col_fun = col3,title="Relative Abundance",at=c(0,0.05,0.1,0.2,0.4,0.6,0.8,1),legend_width = unit(8, "cm"),direction = "horizontal")
pd = packLegend(lgd1, lgd2, lgd3,lgd4,direction = "horizontal")
#Convert to ggplot
gb_S7L= grid.grabExpr(draw(pd))
gg_S7L=as_ggplot(gb_S7L)
gg_S7L
```

##Read Abundance Heatmap core individuals SP / Supplementary Fig 7 B -> Combine with others to get Supplementary Fig7
```{r}
library(cowplot)
#Load abund indv sp
load('./intermediate/gg_S7B.RData')
#Combine plots
sub_fig<-plot_grid(gg_S7A,gg_S7B,labels = c("A","B"),rel_widths = c(1,1),rel_heights=c(1,1),ncol = 2)
fig<-plot_grid(sub_fig,gg_S7L,rel_heights=c(5,1),nrow = 2)
fig
#Save plot
ggsave(plot=fig,filename = "./Supplementary/Supplementary_Figure7.pdf",units = "mm",height = 110, width = 210,scale = 2,dpi=600)
```

##Z-score Heatmap core individuals SP / Supplementary Fig 8 A
```{r}
#Heatmap abudance
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get table
m=as.data.frame(otu_table(pseq.uni_core_m))
##Get z-score
mz=t(apply(m,1,function(x){(x-mean(x))/sd(x)}))

##Get Country:Lifestyle labels
fa_split=paste(as.data.frame(sample_data(pseq.uni_core_m))$country,':',as.data.frame(sample_data(pseq.uni_core_m))$host_lifestyle)

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col2=circlize::colorRamp2(c(-2,-1,0,1,2), c(rev(RColorBrewer::brewer.pal(n = 5, name = "RdBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=sample_data(pseq.uni_core_m)$host_lifestyle,
                              Country=sample_data(pseq.uni_core_m)$country,show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=as.vector(tax_table(pseq.uni_core_m)[,"phylum"]),
                          show_annotation_name = F, col=list(Phylum=phy_col),
                          gp = gpar(col = "black"),show_legend=F)
#Get heatmap
ht_S8A<-Heatmap(mz,clustering_distance_rows = "euclidean",clustering_method_rows = "complete",
            clustering_distance_columns = "euclidean",clustering_method_columns = "complete",
            column_split = fa_split,show_column_names = F, column_title = " ", 
            border_gp = grid::gpar(col = "black", lty = 1),
            col=col2,
            row_names_max_width = unit(8, "cm"),
            show_heatmap_legend = F,
            top_annotation = top_info, right_annotation = left_info)
#Convert to ggplot
gb_S8A=grid.grabExpr(draw(ht_S8A))
gg_S8A=as_ggplot(gb_S8A)
gg_S8A
```

##Common legend for Supplementary Fig 8
```{r}
#Create and combine legends
lgd1=Legend(labels = names(phy_col),legend_gp = gpar(fill=phy_col),title = "Phylum")
lgd2=Legend(labels = names(lifestyle_col),legend_gp = gpar(fill=lifestyle_col),title = "Lifestyle")
lgd3=Legend(labels = names(country_col),legend_gp = gpar(fill=country_col),title = "Country")
lgd4=Legend(col_fun = col2,title="Z-Scored Relative Abundance",at=c(-3,-2,-1,0,1,2,3),legend_width = unit(8, "cm"),direction = "horizontal")
pd = packLegend(lgd1, lgd2, lgd3,lgd4,direction = "horizontal")
#Convert to ggplot
gb_S8L= grid.grabExpr(draw(pd))
gg_S8L=as_ggplot(gb_S8L)
gg_S8L
```


##Read Abundance Heatmap Patterns core individuals SP / Supplementary Fig 8 B -> Combine with others to get Supplementary Fig8
```{r}
library(cowplot)
#Load abund indv sp
load('./intermediate/gg_S8B.RData')
#Combine plots
sub_fig<-plot_grid(gg_S8A,gg_S8B,labels = c("A","B"),rel_widths = c(1,1),rel_heights=c(1,1),ncol = 2)
fig<-plot_grid(sub_fig,gg_S8L,rel_heights=c(5,1),nrow = 2)
fig
#Save plot
ggsave(plot=fig,filename = "./Supplementary/Supplementary_Figure8.pdf",units = "mm",height = 110, width = 210,scale = 2,dpi=600)
```

#Core Analysis by Avg Groups GEN

##Get avg groups values and z-scores
```{r}
#Avg abundance by group
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get m matrix
m=as.data.frame(otu_table(pseq.uni_core_m))
##Get t matrix
m_t=data.frame(t(m),check.names = F)
##Get Country:Lifestyle groups
groups_split=c()
for (i in row.names(m_t)) {
  int_group=paste(data.frame(sample_data(pseq.uni_core_m))[i,"country"],':',data.frame(sample_data(pseq.uni_core_m))[i,"host_lifestyle"])
  groups_split=c(groups_split,int_group)
}
##Join info
m_t_g=cbind(m_t,groups_split)
##Get avg abundance by group
library(dplyr)
avg_abund_group=m_t_g %>% group_by(groups_split) %>% summarise_all("mean") %>% as.data.frame()
row.names(avg_abund_group) <- avg_abund_group$groups_split
avg_abund_group=subset(avg_abund_group,select = -c(groups_split))
avg_abund_group_t=t(avg_abund_group)
##Get z-scores
mt_zscore=t(apply(avg_abund_group_t,1,function(x){(x-mean(x))/sd(x)}))
```

##Elbow Groups Abundance GEN/ Supplementary Figure 1  A -> Combine with SP to get Supplementary Figure 1
```{r}
#Get Elbow graphs for Abundances
library(factoextra)
Elbow_T_S1A=fviz_nbclust(avg_abund_group_t, kmeans, method = "wss") +labs(subtitle = "Elbow method (Taxa)")+geom_vline(xintercept = 4, linetype = 2)
Elbow_G_S1A=fviz_nbclust(t(avg_abund_group_t), kmeans, method = "wss",k.max = 6) +labs(subtitle = "Elbow method (Groups)")+geom_vline(xintercept = 3, linetype = 2)
#Load SP Abundance Groups Elbows
load('./intermediate/gg_S1B.RData')
library(cowplot)
#Combine plots
fig2<-plot_grid(Elbow_T_S1A,Elbow_G_S1A,Elbow_T_S1B,Elbow_G_S1B,labels=c('A','','B',''),nrow = 2,align = "hv")
#Save plot
ggsave(plot=fig2,filename = "./Supplementary/Supplementary_Figure1.pdf",height = 10, width = 15,dpi=600)
```

##Elbow Groups Patterns GEN/ Supplementary Figure 2 A -> Combine with SP to get Supplementary Figure 2
```{r}
# Elbow method for z-score
Elbow_T_S2A=fviz_nbclust(mt_zscore, kmeans, method = "wss") +labs(subtitle = "Elbow method (Taxa)")+geom_vline(xintercept = 3, linetype = 2)
Elbow_G_S2A=fviz_nbclust(t(mt_zscore), kmeans, method = "wss",k.max = 6) +labs(subtitle = "Elbow method (Groups)")+geom_vline(xintercept = 3, linetype = 2)
#Load SP Patterns Groups Elbows
load('./intermediate/gg_S2B.RData')
library(cowplot)
#Combine plots
fig2<-plot_grid(Elbow_T_S2A,Elbow_G_S2A,Elbow_T_S2B,Elbow_G_S2B,labels=c('A','','B',''),nrow = 2,align = "hv")
#Save plot
ggsave(plot=fig2,filename = "./Supplementary/Supplementary_Figure2.pdf",height = 10, width = 15,dpi=600)
```

##Abundance Heatmap Groups / Figure 3 A
```{r}
##Get phylum info
phy_info=c()
for (i in row.names(avg_abund_group_t)) {
  temp_phy=data.frame(tax_table(pseq.uni_core_m))[i,"phylum"]
  phy_info=c(phy_info,temp_phy)
}
##Set Lifestyle info
lifestyle_info=c("Urban","Rural","Urban","Rural","Periurban","Rural","Urban")
##Set Country Info
country_info=c("China","El Salvador","Japan","Madagascar","Peru","Peru","United States")

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col3=circlize::colorRamp2(c(0,0.001,0.005,0.01,0.05,0.1,0.2,0.4,0.8,1), c(rev(RColorBrewer::brewer.pal(n = 10, name = "RdYlBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=lifestyle_info,Country=country_info,
                              show_legend=c(FALSE,FALSE),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=phy_info, show_annotation_name = FALSE,show_legend=FALSE,
                          col=list(Phylum=phy_col),gp = gpar(col = "black"))

#Heatmap
htA1<-Heatmap(avg_abund_group_t,show_column_names = FALSE,col = col3,
              border_gp = grid::gpar(col = "black", lty = 1),
              rect_gp = grid::gpar(col = "black", lwd = 2),
              row_km = 4,row_km_repeats = 100, 
              column_km = 3,column_km_repeats = 100,
              show_heatmap_legend = F,
              top_annotation = top_info,right_annotation = left_info)

#Convert to ggplot
gb_3A=grid.grabExpr(draw(htA1))
gg_3A=as_ggplot(gb_3A)
gg_3A
```

##Common legend for Fig 3
```{r}
#Create and combine legends
lgd1=Legend(labels = names(phy_col),legend_gp = gpar(fill=phy_col),title = "Phylum")
lgd2=Legend(labels = names(lifestyle_col),legend_gp = gpar(fill=lifestyle_col),title = "Lifestyle")
lgd3=Legend(labels = names(country_col),legend_gp = gpar(fill=country_col),title = "Country")
lgd4=Legend(col_fun = col3,title="Average Relative Abundance",at=c(0,0.01,0.05,0.1,0.2,0.4),legend_width = unit(8, "cm"),direction = "horizontal")
pd = packLegend(lgd1, lgd2, lgd3,lgd4,direction = "horizontal")
#Convert to ggplot
gb_3L= grid.grabExpr(draw(pd))
gg_3L=as_ggplot(gb_3L)
gg_3L
```

##Read Abundance Heatmap core groups SP / Fig 3 B -> Combine to get Fig3
```{r}
library(cowplot)
#Load 3B
load('./intermediate/gg_3B.RData')
#Combine plots
sub_fig<-plot_grid(gg_3A,gg_3B,labels = c("A","B"),rel_widths = c(1,1),rel_heights=c(1,1),ncol = 2)
fig<-plot_grid(sub_fig,gg_3L,rel_heights=c(5,1),nrow = 2)
fig
#Save plot
ggsave(plot=fig,filename = "./Figures/Figure3.pdf",units = "mm",height = 120, width = 190,scale = 2,dpi=600)
```

##Zscore Avg Abundance Heatmap Groups / Figure 4 A
```{r}
##Get phylum info
phy_info=c()
for (i in row.names(mt_zscore)) {
  temp_phy=data.frame(tax_table(pseq.uni_core_m))[i,"phylum"]
  phy_info=c(phy_info,temp_phy)
}
##Set Lifestyle info
lifestyle_info=c("Urban","Rural","Urban","Rural","Periurban","Rural","Urban")
##Set Country Info
country_info=c("China","El Salvador","Japan","Madagascar","Peru","Peru","United States")

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col2=circlize::colorRamp2(c(-2,-1,0,1,2), c(rev(RColorBrewer::brewer.pal(n = 5, name = "RdBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=lifestyle_info,Country=country_info,
                              show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=phy_info, show_annotation_name = F,show_legend=F,
                          col=list(Phylum=phy_col),gp = gpar(col = "black"))

#Heatmap
htA2<-Heatmap(mt_zscore, show_column_names = F,col = col2,
              border_gp = grid::gpar(col = "black", lty = 1),
              rect_gp = grid::gpar(col = "black", lwd = 2),
              row_km = 3, row_km_repeats = 100,
              column_km = 3, column_km_repeats = 100,
              show_heatmap_legend = F,
              top_annotation = top_info,right_annotation = left_info)

#Convert to ggplot
gb_4A=grid.grabExpr(draw(htA2))
gg_4A=as_ggplot(gb_4A)
gg_4A
```

##Common legend for Fig 4
```{r}
#Create and combine legends
lgd1=Legend(labels = names(phy_col),legend_gp = gpar(fill=phy_col),title = "Phylum")
lgd2=Legend(labels = names(lifestyle_col),legend_gp = gpar(fill=lifestyle_col),title = "Lifestyle")
lgd3=Legend(labels = names(country_col),legend_gp = gpar(fill=country_col),title = "Country")
lgd4=Legend(col_fun = col2,title="Z-Scored Average Relative Abundance",at=c(-3,-2,-1,0,1,2,3),legend_width = unit(8, "cm"),direction = "horizontal")
pd = packLegend(lgd1, lgd2, lgd3,lgd4,direction = "horizontal")
#Convert to ggplot
gb_4L= grid.grabExpr(draw(pd))
gg_4L=as_ggplot(gb_4L)
gg_4L
```

##Read Heatmap Patterns core groups SP / Fig 4 B -> Combine to get Fig4
```{r}
library(cowplot)
#Load 4B
load('./intermediate/gg_4B.RData')
#Combine plots
sub_fig<-plot_grid(gg_4A,gg_4B,labels = c("A","B"),rel_widths = c(1,1),rel_heights=c(1,1),ncol = 2)
fig<-plot_grid(sub_fig,gg_4L,rel_heights=c(5,1),nrow = 2)
fig
#Save plot
ggsave(plot=fig,filename = "./Figures/Figure4.pdf",units = "mm",height = 120, width = 190,scale = 2,dpi=600)
```







