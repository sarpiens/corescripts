---
title: "Microbiome analysis species"
output: html_document
---

#Load libraries
```{r}
library(phyloseq)
library(microbiome)
library(ggplot2)
library(ggpubr)
library(rstatix)
library(RColorBrewer)
library(gghighlight)
library(UpSetR)
library(ComplexHeatmap)
```

#Load and format data
```{r}
#Read TABLA, TAXONOMIA and METADATA
tabla_SP=data.frame(t(read.csv('./Data/p_nt_enrich_fMAG_SP_count_bracken.txt',sep='\t',row.names = 1,check.names = F)),check.names = F)
taxa_SP=read.csv('./Data/taxa_nt_enrich_fMAG_SP.txt',sep='\t')
metadata=read.csv('./Data/metadata_all_def.csv',header = T, sep='\t',row.names = 1)

#Change row names to desired format for TABLA and TAXONOMIA 
#(We can do this with out problem, because the TAXONOMY table was created based on the order of the TABLE table) 
row.names(tabla_SP)=taxa_SP$species
row.names(taxa_SP)=taxa_SP$species
```

#Filter undesired taxa for TABLE and TAXONOMY
```{r}
#Define %not_in% function
`%not_in%` <- purrr::negate(`%in%`)
#Filter kingdoms Metazoa(33208), Viridiplantae(33090) and undefined taxa(NAs)
tax_filtered_SP=taxa_SP[taxa_SP$kingdom %not_in% c('Viridiplantae(33090)','Metazoa(33208)'),]
tax_filtered_SP=tax_filtered_SP[!is.na(tax_filtered_SP$superkingdom),]
tabla_SP_filtered=tabla_SP[row.names(tabla_SP) %in% tax_filtered_SP$species,]
```

#Make phyloseq object
```{r}
#Pre-format 
##Taxa
tax_mat_SP=as.matrix(tax_filtered_SP)
TAX_SP=tax_table(tax_mat_SP)
##Count_data as matrix
matr_tabla_SP=as.matrix(tabla_SP_filtered)
t_SP=otu_table(matr_tabla_SP,taxa_are_rows = T)
##Metadata
samples_meta=sample_data(metadata)
#Transform to phyloseq object 
pseq=phyloseq(t_SP,samples_meta,TAX_SP)
#keep only taxa with positive sums
pseq<-prune_taxa(taxa_sums(pseq)>0,pseq)
pseq
```

#Normalization - proporcions
```{r}
#Get "compositional" version of data(Relative abundance/ Proporcions)
pseq.rel <- microbiome::transform(pseq, "compositional")
```

#Microbial composition description /  Top 25 taxa SP -> Supplementary Figure6

##Self-made function (taxa_avg_abund)
```{r}
taxa_avg_abund <- function(x) {
    
    sort(rowSums(microbiome::abundances(x)), decreasing=TRUE)/nsamples(x)
    
}
```

###Get Data-Table
```{r}
#Get top 25 most abundand taxa 
top25_tax=top_taxa(pseq.rel,n=25)
pseq.rel.top25_tax=prune_taxa(top25_tax,pseq.rel)
#Reshape data
top25_tax_abund=reshape2::melt(otu_table(pseq.rel.top25_tax))
top25_tax_abund=setNames(top25_tax_abund,c("Tax","Sample","Abundance"))
#Add metadata
top25_tax_data=merge(top25_tax_abund,metadata,by.x="Sample",by.y="row.names")
#Create new variable summing lifestyle+country
top25_tax_data$CT_LF <- paste(top25_tax_data$country,':',top25_tax_data$host_lifestyle)
```

###Boxplot compositions
```{r}
#Create boxplot
dot_plot=ggplot(data=top25_tax_data, aes(y=reorder(Tax, Abundance, FUN = mean), x= Abundance))+geom_boxplot(aes(fill=Tax))
#Format graph
dot_plot=dot_plot+xlab("Relative abundance")+ylab("Top 25 Taxa")
#Add means to graph
dot_plot=dot_plot+stat_summary(aes(group=Tax),fun=mean, geom="point", shape=25, size=2, color="black", fill="red")
#Change theme and remove legend
dot_plot=dot_plot+theme_bw()+theme(legend.position = "none")
#Show result
print(dot_plot)
ggsave("./Supplementary/Supplementary_Figure6.pdf",plot=dot_plot,height = 12, width = 18,dpi=600)
```

```{r}
#Get avg values for all samples
taxa_avg_abund(pseq.rel.top25_tax)
```

#Core analysis

##Universal Core (Intersection between cores) / Supplementary Figure 5A
```{r}
#Set thresholds
PREV=0.9
ABUND=0.0001

#Pan-Core (>0.0001 relative abundance in => 90% of all samples)
pseq.core <- core(pseq.rel, detection = ABUND, prevalence = PREV,include.lowest = T)
core.taxa.all <- core_members(pseq.rel, detection = ABUND, prevalence = PREV,include.lowest = T)

#Cores by life style
pseq.rel_Rural= prune_samples(meta(pseq.rel)$host_lifestyle == "Rural",pseq.rel)
core.taxa.rural <- core_members(pseq.rel_Rural, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Urban= prune_samples(meta(pseq.rel)$host_lifestyle == "Urban",pseq.rel)
core.taxa.Urban <- core_members(pseq.rel_Urban, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_PS= prune_samples(meta(pseq.rel)$host_lifestyle == "Periurban shantytown",pseq.rel)
core.taxa.PS <- core_members(pseq.rel_PS, detection = ABUND, prevalence = PREV,include.lowest = T)

#Cores by country
pseq.rel_China= prune_samples(meta(pseq.rel)$country == "China",pseq.rel)
core.taxa.China <- core_members(pseq.rel_China, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Peru= prune_samples(meta(pseq.rel)$country == "Peru",pseq.rel)
core.taxa.Peru <- core_members(pseq.rel_Peru, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Md= prune_samples(meta(pseq.rel)$country == "Madagascar",pseq.rel)
core.taxa.Md <- core_members(pseq.rel_Md, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Japan= prune_samples(meta(pseq.rel)$country == "Japan",pseq.rel)
core.taxa.Japan <- core_members(pseq.rel_Japan, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_Sal= prune_samples(meta(pseq.rel)$country == "El Salvador",pseq.rel)
core.taxa.Sal <- core_members(pseq.rel_Sal, detection = ABUND, prevalence = PREV,include.lowest = T)

pseq.rel_US= prune_samples(meta(pseq.rel)$country == "United States",pseq.rel)
core.taxa.US <- core_members(pseq.rel_US, detection = ABUND, prevalence = PREV,include.lowest = T)

#Get presence-absence data.frame
listIn= list(core.taxa.all,core.taxa.rural,core.taxa.Urban,core.taxa.PS,core.taxa.China,core.taxa.Peru,core.taxa.Md,core.taxa.Japan,core.taxa.Sal,core.taxa.US)
cores_df<-as.data.frame(list_to_matrix(listIn))
#Change names
colnames(cores_df)<- c("Pan-Core","Rural","Urban","Periurban shantytown","China","Peru","Madagascar","Japan","El Salvador","United States")
#Create metadatos data.frame  for coloring
variables<-c("Pan","Style","Style","Style","Country","Country","Country","Country","Country","Country")
sets<-c("Pan-Core","Rural","Periurban shantytown","Urban","Peru","Madagascar","El Salvador","Japan","China","United States")
metadatos<- as.data.frame(cbind(sets,variables))

#Plot and show 
interset_cores <- upset(cores_df, mainbar.y.label="Number of Intersecting Taxa",sets.x.label="Number of Core Taxa",sets = c("Pan-Core","Urban","Periurban shantytown","Rural","Japan","China","United States","Peru","Madagascar","El Salvador"),order.by = "freq",keep.order = TRUE, text.scale = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5),set.metadata = list(data = metadatos, plots = list(list(type = "matrix_rows", column = "variables", colors = c(Pan = "green", Style = "yellow", Country = "purple")))))

#Save plot png
#png(file="./intermediate/core_intersections_SP_rel_0.0001_preval_0.9.png",width=10, height=6)
#interset_cores
#dev.off()

#Save plot pdf
pdf(file="./intermediate/core_intersections_SP_rel_0.0001_preval_0.9.pdf",width=10, height=6)
interset_cores
dev.off()
```

##Get Universal core taxa(Intersect)
```{r}
universal_core_taxa=row.names(cores_df %>% dplyr::filter_all(dplyr::all_vars(.==1)))
pseq.uni_core= prune_taxa(universal_core_taxa,pseq.rel)
```

##Get Prevalence-Abundance Heatmap/ Supplementary Figure 5C
```{r}
#Original plot
##Set parameters
prevalences <- seq(.05, 1, .05)
detections <- c(0.01, 0.1, 0.5, 1,5,10)/100
color=rev(RColorBrewer::brewer.pal(9, "Spectral"))

##Initial Plot to get data
p_core1 <- plot_core(pseq.uni_core, plot.type = "heatmap", colours = color,
    prevalences = prevalences, detections = detections)

##Get input format
input_data=reshape2::acast(p_core1$data,Taxa~DetectionThreshold,value.var = "Prevalence")

##Order by abundance
input_data=input_data[names(taxa_avg_abund(pseq.uni_core)),]

##Get Avg relative abund values
avg_rel=as.vector(taxa_avg_abund(pseq.uni_core))

##Get phylums for ASVs
phy_tax=c()
for (i in names(taxa_avg_abund(pseq.uni_core))) {
  temp_row=tax_table(pseq.uni_core)[i,"phylum"]
  phy_tax=c(phy_tax,temp_row)
  }

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
avg_rel_col=circlize::colorRamp2(c(0,0.005,0.01,0.05,0.1,0.2), c("grey",rev(RColorBrewer::brewer.pal(n = 5, name = "RdYlBu"))))


##Include annotations
lateral_info <-ComplexHeatmap::rowAnnotation(Phylum=phy_tax,`Average Relative \nAbundance`=avg_rel,
                                             show_annotation_name = c(FALSE,FALSE),gp = grid::gpar(col ="black"),
                                             col=list(Phylum=phy_col,`Average Relative \nAbundance`=avg_rel_col),
                                             annotation_legend_param=list(`Average Relative \nAbundance`=list(legend_height = unit(4, "cm"), at=c(0,0.005,0.01,0.05,0.1,0.2))))

##Get initial heatmap
ht<-ComplexHeatmap::Heatmap(input_data,heatmap_legend_param=list(title="Prevalence",at=c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)),show_column_names = TRUE,
                        row_order = rownames(input_data), column_order = colnames(input_data),column_names_rot = 45,column_title_side = "bottom",
                        column_title = "Detection Threshold (Relative Abundance)",row_names_max_width = unit(10, "cm"),border_gp = grid::gpar(col = "black", lty = 1),
                        col = rev(RColorBrewer::brewer.pal(n = 10, name = "Spectral")),rect_gp = grid::gpar(col = "black", lwd = 2),
                        right_annotation = lateral_info,
                        cell_fun=function(j, i, x, y, w, h, col) { grid.text(round(input_data[i, j],3), x, y)})

##ajust legend
ComplexHeatmap::draw(ht, merge_legend = TRUE,heatmap_legend_side = "right", annotation_legend_side = "right")
```

```{r,eval=FALSE,include=TRUE}
#Save plot
png(filename = "./intermediate/heatmap_prev_abund_universal_core_sp.png", width = 10, height = 6, units = "in", res = 600)
ComplexHeatmap::draw(ht, merge_legend = TRUE,heatmap_legend_side = "right", annotation_legend_side = "right")
dev.off()
```

##Get taxa graph/ Supplementary Figure 5B
```{r,eval=FALSE,include=TRUE}
#Get copy to play with
pseq.uni_core_c <- pseq.uni_core
#Remove NA and re-order
tax_table(pseq.uni_core_c)<-tax_table(pseq.uni_core_c)[,c('superkingdom','phylum','class','order','family','genus','species')]
#Remove taxid from taxa-data
tax_table(pseq.uni_core_c)<-apply(tax_table(pseq.uni_core_c), 2, function(x) gsub("\\s*\\([^\\)]+\\)","",x))
#Load library and parse phyloseq
library(metacoder)
pseq.core_coder=parse_phyloseq(pseq.uni_core_c)
#Get graph
set.seed(13)
pseq_coder_graph_core<-heat_tree(pseq.core_coder,
                                 node_label = paste0(taxon_names, "[", n_obs, "]"),
                                 node_label_size=n_obs,
                                 node_size=n_obs,
                                 node_color = ifelse(is_leaf, "#AADB31", "grey"),
                                 layout="da",
                                 #initial_layout="re",
                                 repel_force = 5,
                                 edge_color = "skyblue",
                                 make_node_legend=F,
                                 node_label_size_trans = "area")
#Show graph
print(pseq_coder_graph_core)
```

##Combine and Plot Supplementary Figure 5
```{r}
#Load library
library(cowplot)
#Load images as ggplots
top <- ggdraw()+draw_image("./intermediate/core_intersections_SP_rel_0.0001_preval_0.9.png")
bot <- ggdraw()+draw_image("./intermediate/heatmap_prev_abund_universal_core_sp.png")
#Combine plots
ri_fig<-plot_grid(top,bot,nrow = 2)
ri_fig2<-plot_grid(NULL,NULL,labels = c('A','C'),nrow = 2)
fig<-plot_grid(ri_fig2,ri_fig,pseq_coder_graph_core,NULL, labels = c("","","B",""),rel_widths = c(0.07,1,1,0.07),ncol = 4)
#Save plot
ggsave(plot=fig,filename = "./Supplementary/Supplementary_Figure5.pdf",units = "mm",height = 120, width = 190,scale = 2,dpi=600)
```

##Get all cores taxa table/ Supplementary Table 6
```{r}
#Get Taxonomies
All_Cores_list=rownames(cores_df)
pseq.All_Cores=prune_taxa(All_Cores_list,pseq.rel)
taxo_All_Cores=data.frame(tax_table(pseq.All_Cores))

#Combine with presence-absense object
All_Cores_taxa=merge(taxo_All_Cores,cores_df,by=0)
#Remove row.names column and kingdom(empty column)
All_Cores_taxa$Row.names<-NULL
All_Cores_taxa$kingdom<-NULL
#Re-order rows so Pan-Core taxa go first
All_Cores_taxa <- All_Cores_taxa[order(-All_Cores_taxa$`Pan-Core`),]
#Add Universal core column(intersect)
Universal=c()
for (i in All_Cores_taxa$species) {
  if (i %in% universal_core_taxa) {
    Universal=c(Universal,1)
  } else{Universal=c(Universal,0)}
}
All_Cores_taxa$Universal=Universal
#Re-order rows so Universal taxa go first
All_Cores_taxa <- All_Cores_taxa[order(-All_Cores_taxa$Universal),]
#Save the resulting table to excel file
library("writexl")
writexl::write_xlsx(All_Cores_taxa,"./Supplementary/Supplementary_Table6.xlsx")
```


##Abundance Heatmap core individuals SP / Supplementary Fig 7 B
```{r}
#Heatmap abudance
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get table
m=as.data.frame(otu_table(pseq.uni_core_m))

##Get Country:Lifestyle labels
fa_split=paste(as.data.frame(sample_data(pseq.uni_core_m))$country,':',as.data.frame(sample_data(pseq.uni_core_m))$host_lifestyle)

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col3=circlize::colorRamp2(c(0,0.001,0.005,0.01,0.05,0.1,0.2,0.4,0.8,1), c(rev(RColorBrewer::brewer.pal(n = 10, name = "RdYlBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=sample_data(pseq.uni_core_m)$host_lifestyle,
                              Country=sample_data(pseq.uni_core_m)$country,show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=as.vector(tax_table(pseq.uni_core_m)[,"phylum"]),
                          show_annotation_name = F, col=list(Phylum=phy_col),
                          gp = gpar(col = "black"),show_legend=F)
#Get heatmap
ht_S7B<-Heatmap(m,clustering_distance_rows = "euclidean",clustering_method_rows = "complete",
            clustering_distance_columns = "euclidean",clustering_method_columns = "complete",
            column_split = fa_split,show_column_names = F, column_title = " ", col = col3,
            row_names_max_width = unit(8, "cm"), 
            border_gp = grid::gpar(col = "black", lty = 1),
            show_heatmap_legend = F,top_annotation = top_info, right_annotation = left_info)
#Convert to ggplot
gb_S7B=grid.grabExpr(draw(ht_S7B))
gg_S7B=as_ggplot(gb_S7B)
gg_S7B
#Save ggplot object for latter
save(gg_S7B,file = "./intermediate/gg_S7B.RData")
```

##Z-score Heatmap core individuals SP / Supplementary Fig 8 B
```{r}
#Heatmap abudance
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get table
m=as.data.frame(otu_table(pseq.uni_core_m))
##Get z-score
mz=t(apply(m,1,function(x){(x-mean(x))/sd(x)}))

##Get Country:Lifestyle labels
fa_split=paste(as.data.frame(sample_data(pseq.uni_core_m))$country,':',as.data.frame(sample_data(pseq.uni_core_m))$host_lifestyle)

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col2=circlize::colorRamp2(c(-2,-1,0,1,2), c(rev(RColorBrewer::brewer.pal(n = 5, name = "RdBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=sample_data(pseq.uni_core_m)$host_lifestyle,
                              Country=sample_data(pseq.uni_core_m)$country,show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=as.vector(tax_table(pseq.uni_core_m)[,"phylum"]),
                          show_annotation_name = F, col=list(Phylum=phy_col),
                          gp = gpar(col = "black"),show_legend=F)
#Get heatmap
ht_S8B<-Heatmap(mz,clustering_distance_rows = "euclidean",clustering_method_rows = "complete",
            clustering_distance_columns = "euclidean",clustering_method_columns = "complete",
            column_split = fa_split,show_column_names = F, column_title = " ", 
            border_gp = grid::gpar(col = "black", lty = 1),
            col=col2,
            row_names_max_width = unit(8, "cm"),
            show_heatmap_legend = F,
            top_annotation = top_info, right_annotation = left_info)
#Convert to ggplot
gb_S8B=grid.grabExpr(draw(ht_S8B))
gg_S8B=as_ggplot(gb_S8B)
gg_S8B
#Save ggplot object for latter
save(gg_S8B,file = "./intermediate/gg_S8B.RData")
```

#Core Analysis by Avg Groups SP

##Get avg groups values and z-scores
```{r}
#Avg abundance by group
##Get copy pseq to play
pseq.uni_core_m <- pseq.uni_core
sample_data(pseq.uni_core_m)$host_lifestyle[sample_data(pseq.uni_core_m)$host_lifestyle=="Periurban shantytown"]<-"Periurban"
##Get m matrix
m=as.data.frame(otu_table(pseq.uni_core_m))
##Get t matrix
m_t=data.frame(t(m),check.names = F)
##Get Country:Lifestyle groups
groups_split=c()
for (i in row.names(m_t)) {
  int_group=paste(data.frame(sample_data(pseq.uni_core_m))[i,"country"],':',data.frame(sample_data(pseq.uni_core_m))[i,"host_lifestyle"])
  groups_split=c(groups_split,int_group)
}
##Join info
m_t_g=cbind(m_t,groups_split)
##Get avg abundance by group
library(dplyr)
avg_abund_group=m_t_g %>% group_by(groups_split) %>% summarise_all("mean") %>% as.data.frame()
row.names(avg_abund_group) <- avg_abund_group$groups_split
avg_abund_group=subset(avg_abund_group,select = -c(groups_split))
avg_abund_group_t=t(avg_abund_group)
##Get z-scores
mt_zscore=t(apply(avg_abund_group_t,1,function(x){(x-mean(x))/sd(x)}))
```

##Elbow Groups Abundance/ Supplementary Figure 1 B
```{r}
#Get Elbow graphs for abundances
library(factoextra)
Elbow_T_S1B=fviz_nbclust(avg_abund_group_t, kmeans, method = "wss") +labs(subtitle = "Elbow method (Taxa)")+geom_vline(xintercept = 3, linetype = 2)
Elbow_G_S1B=fviz_nbclust(t(avg_abund_group_t), kmeans, method = "wss",k.max = 6) +labs(subtitle = "Elbow method (Groups)")+geom_vline(xintercept = 3, linetype = 2)
#Save ggplots for latter
save(Elbow_T_S1B,Elbow_G_S1B,file='./intermediate/gg_S1B.RData')
```

##Elbow Groups Patterns/ Supplementary Figure 2 B
```{r}
# Elbow method for z-score
Elbow_T_S2B=fviz_nbclust(mt_zscore, kmeans, method = "wss") +labs(subtitle = "Elbow method (Taxa)")+geom_vline(xintercept = 3, linetype = 2)
Elbow_G_S2B=fviz_nbclust(t(mt_zscore), kmeans, method = "wss",k.max = 6) +labs(subtitle = "Elbow method (Groups)")+geom_vline(xintercept = 3, linetype = 2)
#Save ggplots for latter
save(Elbow_T_S2B,Elbow_G_S2B,file='./intermediate/gg_S2B.RData')
```

##Abundance Heatmap Groups / Figure 3 B
```{r}
##Get phylum info
phy_info=c()
for (i in row.names(avg_abund_group_t)) {
  temp_phy=data.frame(tax_table(pseq.uni_core_m))[i,"phylum"]
  phy_info=c(phy_info,temp_phy)
}
##Set Lifestyle info
lifestyle_info=c("Urban","Rural","Urban","Rural","Periurban","Rural","Urban")
##Set Country Info
country_info=c("China","El Salvador","Japan","Madagascar","Peru","Peru","United States")
##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col3=circlize::colorRamp2(c(0,0.001,0.005,0.01,0.05,0.1,0.2,0.4,0.8,1), c(rev(RColorBrewer::brewer.pal(n = 10, name = "RdYlBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=lifestyle_info,Country=country_info,
                              show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=phy_info, show_annotation_name = F,show_legend=F,
                          col=list(Phylum=phy_col),gp = gpar(col = "black"))

#Heatmap
htA1<-Heatmap(avg_abund_group_t,show_column_names = F,col = col3,
              border_gp = grid::gpar(col = "black", lty = 1),
              rect_gp = grid::gpar(col = "black", lwd = 2),
              row_km = 3,row_km_repeats = 100, 
              column_km = 3,column_km_repeats = 100,
              row_names_max_width = unit(8, "cm"),
              show_heatmap_legend = F,
              top_annotation = top_info,right_annotation = left_info)

#Convert to ggplot
gb_3B=grid.grabExpr(draw(htA1))
gg_3B=as_ggplot(gb_3B)
gg_3B
#Save ggplot object for latter
save(gg_3B,file = "./intermediate/gg_3B.RData")
```

##Zscore Avg Abundance Heatmap Groups / Figure 4 B
```{r}
##Get phylum info
phy_info=c()
for (i in row.names(mt_zscore)) {
  temp_phy=data.frame(tax_table(pseq.uni_core_m))[i,"phylum"]
  phy_info=c(phy_info,temp_phy)
}
##Set Lifestyle info
lifestyle_info=c("Urban","Rural","Urban","Rural","Periurban","Rural","Urban")
##Set Country Info
country_info=c("China","El Salvador","Japan","Madagascar","Peru","Peru","United States")

##Set Colors
phy_col=c(`Bacteroidetes(976)`="#845ec2",`Firmicutes(1239)`="#f9f871",`Actinobacteria(201174)`="#eb5e0b",`Proteobacteria(1224)`="red")
lifestyle_col=c(Rural="#a3ddcb",Periurban="#e8e9a1",Urban="#e5707e")
country_col=c(`El Salvador`="#f0d8a8",Madagascar="#3d1c00",`United States`="#cbe86b",Japan="#fa2a00",China="#40c0cb",Peru="#67917a")
col2=circlize::colorRamp2(c(-2,-1,0,1,2), c(rev(RColorBrewer::brewer.pal(n = 5, name = "RdBu"))))

#Get TOP annotations 
top_info <- HeatmapAnnotation(Lifestyle=lifestyle_info,Country=country_info,
                              show_legend=c(F,F),
                              col = list(Lifestyle=lifestyle_col,Country=country_col))
#Get LEFT annotations 
left_info <-rowAnnotation(Phylum=phy_info, show_annotation_name = F,show_legend=F,
                          col=list(Phylum=phy_col),gp = gpar(col = "black"))

#Heatmap
htA2<-Heatmap(mt_zscore,show_column_names = F,col = col2,
              border_gp = grid::gpar(col = "black", lty = 1),
              rect_gp = grid::gpar(col = "black", lwd = 2),
              row_km = 3,row_km_repeats = 100, 
              column_km = 3,column_km_repeats = 100,
              row_names_max_width = unit(8, "cm"),
              show_heatmap_legend = F,
              top_annotation = top_info,right_annotation = left_info)

#Convert to ggplot
gb_4B=grid.grabExpr(draw(htA2))
gg_4B=as_ggplot(gb_4B)
gg_4B
#Save ggplot object for latter
save(gg_4B,file = "./intermediate/gg_4B.RData")
```